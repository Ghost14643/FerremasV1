{% extends "ferremasApp/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-center">Nuestra Tienda</h2>

    <div class="row mb-3">
        <div class="col-md-4">
            <select id="categoria-filtro" class="form-control">
                <option value="todos">Todas las Categorías</option>
                </select>
        </div>
        <div class="col-md-4">
            <input type="text" id="busqueda-producto" class="form-control" placeholder="Buscar producto...">
        </div>
        <div class="col-md-4 text-right">
            <button id="ver-carrito" class="btn btn-primary">Ver Carrito (<span id="carrito-cantidad">0</span>)</button>
        </div>
    </div>

    <div class="row" id="productos-container">
        </div>

    <div class="row mt-4">
        <div class="col-md-12 text-center" id="paginacion-container">
            </div>
    </div>

    <div class="modal fade" id="carrito-modal" tabindex="-1" role="dialog" aria-labelledby="carritoModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="carritoModalLabel">Carrito de Compras</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="carrito-contenido">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Seguir Comprando</button>
                    <button type="button" class="btn btn-success" id="finalizar-compra">Finalizar Compra</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mensaje-container" class="alert alert-success mt-3" style="display: none;">
        </div>

</div>

<script>
    const productosContainer = document.getElementById('productos-container');
    const carritoModal = new bootstrap.Modal(document.getElementById('carrito-modal'));
    const carritoContenido = document.getElementById('carrito-contenido');
    const verCarritoBtn = document.getElementById('ver-carrito');
    const finalizarCompraBtn = document.getElementById('finalizar-compra');
    const categoriaFiltro = document.getElementById('categoria-filtro');
    const busquedaProducto = document.getElementById('busqueda-producto');
    const paginacionContainer = document.getElementById('paginacion-container');
    const carritoCantidad = document.getElementById('carrito-cantidad');
    const mensajeContainer = document.getElementById('mensaje-container');

    let carrito = [];
    let productos = []; // Array para almacenar todos los productos obtenidos de la API
    let categorias = [];
    const productosPorPagina = 12;
    let paginaActual = 1;

    // Función para mostrar mensajes al usuario
    function mostrarMensaje(mensaje, tipo = 'success', duracion = 3000) {
        mensajeContainer.textContent = mensaje;
        mensajeContainer.classList.remove('alert-success', 'alert-danger', 'alert-warning', 'alert-info');
        mensajeContainer.classList.add(`alert-${tipo}`);
        mensajeContainer.style.display = 'block';
        setTimeout(() => {
            mensajeContainer.style.display = 'none';
        }, duracion);
    }

    // Función para obtener los productos de la API (Ejemplo: FakeStore API)
    async function obtenerProductos() {
        try {
            const response = await fetch('https://fakestoreapi.com/products'); // Reemplazar con tu API
            const data = await response.json();
            productos = data;
            obtenerCategorias();
            mostrarProductosPaginados(productos);
        } catch (error) {
            console.error('Error al obtener productos:', error);
            productosContainer.innerHTML = '<p class="text-danger">Error al cargar los productos.</p>';
        }
    }

    // Función para obtener las categorías de los productos
    function obtenerCategorias() {
        categorias = ['todos', ...new Set(productos.map(producto => producto.category))];
        llenarFiltroCategorias();
    }

    // Función para llenar el filtro de categorías
    function llenarFiltroCategorias() {
        categoriaFiltro.innerHTML = '<option value="todos">Todas las Categorías</option>'; // Limpiar antes de llenar
        categorias.forEach(categoria => {
            const opcion = document.createElement('option');
            opcion.value = categoria;
            opcion.textContent = categoria.charAt(0).toUpperCase() + categoria.slice(1);
            categoriaFiltro.appendChild(opcion);
        });
    }

    // Función para filtrar los productos
    function filtrarProductos() {
        const categoriaSeleccionada = categoriaFiltro.value;
        const textoBusqueda = busquedaProducto.value.toLowerCase();

        let productosFiltrados = productos;

        if (categoriaSeleccionada !== 'todos') {
            productosFiltrados = productosFiltrados.filter(producto => producto.category === categoriaSeleccionada);
        }

        if (textoBusqueda) {
            productosFiltrados = productosFiltrados.filter(producto =>
                producto.title.toLowerCase().includes(textoBusqueda) ||
                producto.description.toLowerCase().includes(textoBusqueda)
            );
        }

        mostrarProductosPaginados(productosFiltrados);
    }

    // Función para mostrar los productos paginados
    function mostrarProductosPaginados(productosAMostrar) {
        const indiceInicio = (paginaActual - 1) * productosPorPagina;
        const indiceFin = indiceInicio + productosPorPagina;
        const productosPagina = productosAMostrar.slice(indiceInicio, indiceFin);

        mostrarProductos(productosPagina);
        mostrarPaginacion(productosAMostrar.length);
    }

    // Función para mostrar los productos en la página
    function mostrarProductos(productos) {
        productosContainer.innerHTML = '';
        if (productos.length === 0) {
            productosContainer.innerHTML = '<p class="text-info">No se encontraron productos.</p>';
            return;
        }

        productos.forEach(producto => {
            const productoDiv = document.createElement('div');
            productoDiv.classList.add('col-md-4', 'mb-4');
            productoDiv.innerHTML = `
                <div class="card h-100">
                    <img src="${producto.image}" class="card-img-top" alt="${producto.title}">
                    <div class="card-body">
                        <h5 class="card-title">${producto.title}</h5>
                        <p class="card-text">${producto.description.substring(0, 100)}...</p>
                        <p class="card-text">Precio: $${producto.price.toFixed(2)}</p>
                        <button class="btn btn-sm btn-outline-secondary agregar-carrito" data-id="${producto.id}">Agregar al Carrito</button>
                    </div>
                </div>
            `;
            productosContainer.appendChild(productoDiv);
        });

        const botonesAgregar = document.querySelectorAll('.agregar-carrito');
        botonesAgregar.forEach(boton => {
            boton.addEventListener('click', agregarProductoAlCarrito);
        });
    }

    // Función para mostrar la paginación
    function mostrarPaginacion(totalProductos) {
        const totalPaginas = Math.ceil(totalProductos / productosPorPagina);
        paginacionContainer.innerHTML = '';

        if (totalPaginas <= 1) return; // No mostrar paginación si hay solo una página

        for (let i = 1; i <= totalPaginas; i++) {
            const botonPagina = document.createElement('button');
            botonPagina.classList.add('btn', 'btn-sm', 'btn-light', 'mr-1');
            botonPagina.textContent = i;
            if (i === paginaActual) {
                botonPagina.classList.add('active');
            }
            botonPagina.addEventListener('click', () => {
                paginaActual = i;
                filtrarProductos();
            });
            paginacionContainer.appendChild(botonPagina);
        }
    }

    // Función para agregar un producto al carrito
    function agregarProductoAlCarrito(event) {
        const productoId = parseInt(event.target.dataset.id);
        const productoSeleccionado = productos.find(producto => producto.id === productoId);

        if (productoSeleccionado) {
            const existeEnCarrito = carrito.find(item => item.id === productoSeleccionado.id);
            if (existeEnCarrito) {
                existeEnCarrito.cantidad++;
            } else {
                carrito.push({ ...productoSeleccionado, cantidad: 1 });
            }
            actualizarCantidadCarrito();
            mostrarMensaje('Producto agregado al carrito.', 'success');
        }
    }

    // Función para mostrar los items del carrito en el modal
    function mostrarCarrito() {
        carritoContenido.innerHTML = '';
        let total = 0;
        if (carrito.length === 0) {
            carritoContenido.innerHTML = '<p>El carrito está vacío.</p>';
        } else {
            carrito.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('d-flex', 'justify-content-between', 'mb-2', 'align-items-center');
                itemDiv.innerHTML = `
                    <div>${item.title} (
                        <input type="number" class="cantidad-item" data-id="${item.id}" value="${item.cantidad}" min="1"
                               style="width: 60px;">
                        )
                    </div>
                    <div>$${(item.price * item.cantidad).toFixed(2)}</div>
                    <button class="btn btn-sm btn-danger eliminar-item" data-id="${item.id}">Eliminar</button>
                `;
                carritoContenido.appendChild(itemDiv);
                total += item.price * item.cantidad;
            });
            const totalDiv = document.createElement('div');
            totalDiv.classList.add('font-weight-bold', 'text-right');
            totalDiv.textContent = `Total: $${total.toFixed(2)}`;
            carritoContenido.appendChild(totalDiv);

            // Agregar event listeners para actualizar y eliminar items
            const cantidadItems = document.querySelectorAll('.cantidad-item');
            cantidadItems.forEach(input => {
                input.addEventListener('change', actualizarCantidadItem);
            });

            const eliminarItems = document.querySelectorAll('.eliminar-item');
            eliminarItems.forEach(boton => {
                boton.addEventListener('click', eliminarItem);
            });
        }
    }

    // Función para actualizar la cantidad de un item en el carrito
    function actualizarCantidadItem(event) {
        const itemId = parseInt(event.target.dataset.id);
        const nuevaCantidad = parseInt(event.target.value);

        if (nuevaCantidad > 0) {
            const itemEnCarrito = carrito.find(item => item.id === itemId);
            if (itemEnCarrito) {
                itemEnCarrito.cantidad = nuevaCantidad;
                mostrarCarrito(); // Re-renderizar el carrito
                actualizarCantidadCarrito();
            }
        } else {
            event.target.value = 1; // Evitar cantidades negativas o cero
            event.target.value = 1;
        }
    }

    // Función para eliminar un item del carrito
    function eliminarItem(event) {
        const itemId = parseInt(event.target.dataset.id);
        carrito = carrito.filter(item => item.id !== itemId);
        mostrarCarrito();
        actualizarCantidadCarrito();
        mostrarMensaje('Producto eliminado del carrito.', 'warning');
    }

    // Función para actualizar la cantidad mostrada en el botón "Ver Carrito"
    function actualizarCantidadCarrito() {
        let totalCantidad = 0;
        carrito.forEach(item => {
            totalCantidad += item.cantidad;
        });
        carritoCantidad.textContent = totalCantidad;
    }

    // Event listeners
    verCarritoBtn.addEventListener('click', () => {
        mostrarCarrito();
        carritoModal.show();
    });

    finalizarCompraBtn.addEventListener('click', () => {
        // Aquí iría la lógica para procesar la compra (enviar a otra API, etc.)
        alert('¡Compra finalizada! (Funcionalidad no implementada en este ejemplo)');
        carrito = [];
        carritoModal.hide();
        actualizarCantidadCarrito();
        mostrarMensaje('Compra finalizada.', 'success');
    });

    categoriaFiltro.addEventListener('change', filtrarProductos);
    busquedaProducto.addEventListener('input', filtrarProductos);

    // Cargar los productos al cargar la página
    obtenerProductos();
</script>

{% endblock %}